' Gambas class file

PRIVATE $aktTag AS Integer = 1 ' tag-version to use
PRIVATE $recursive AS Boolean = FALSE ' list files recursively

STATIC PUBLIC cols AS String[] ' contains the patterns to display in Flist

PUBLIC fall AS NEW Collection ' contains the keys (paths) of all files displayed in Flist
PUBLIC fsel AS NEW CTag ' should contain the Tag of the selected file (not sure if everywhere possible set)
PUBLIC fchg AS NEW Collection ' contains something, i dunno right now...

PROPERTY READ changed AS Boolean ' if something was changed on the displayed files it is remarked here
PRIVATE halt AS Boolean = FALSE ' during scanning the directories this will stop the read-in process

STATIC PUBLIC Flist AS CFView

PUBLIC SUB _new()
  
  Flist = NEW CFView(VBox3) AS "Flist"
  'Object.Attach(Flist, ME, "Flist")
  Flist.x = 7
  Flist.y = 7
  Flist.W = 469
  Flist.h = 441
  Flist.expand = TRUE
  
  cols = Split(Settings["cols", "%f,%T,%A,%B,%Y,%G,%b"], ",")
  actFlist
  Flist.Columns.Sort = If(cols.Find("%B") > -1, cols.Find("%B"), 0)
  Flist.cols = cols
  
  ME.Center
  
END


' updates columns Flist is showing based on FMain.cols as well as files
PUBLIC SUB actFlist() 
  
  DIM x AS Integer
  DIM a AS CFile
  DIM b AS NEW Picture
  DIM e AS NEW Picture
  
  b = Picture.Load("icons/16/blank.png")
  e = Picture.Load("icons/16/edited.png")
  
  Flist.Columns.Count = cols.Count
  Flist.Columns.Sort = -1
  
  FOR EACH a IN fall
    FOR x = 0 TO cols.Max
      Flist[a.path][x] = MHelp.getDesc(cols[x], a)
      IF cols[x] = "%Y" AND Flist[a.path][x] = 0 THEN Flist[a.path][x] = ""
      Flist[a.path].Picture = If(a.changed, e, b)
    NEXT 
  NEXT
  FOR x = 0 TO cols.Max
    Flist.Columns[x].Text = MHelp.desc[cols[x]]
    'Flist.Columns[x].AutoResize = TRUE
  NEXT 
  
  Flist.Columns.Sort = 3
  
END

' updates the whole Flist out of the directory selected in DirView1
PUBLIC SUB UpdFlist()
  
  DIM pass AS String[]
  DIM x AS Integer
  DIM e AS CFile
  
  IF ME.changed THEN 
    IF Message.Warning("You made changes to " & fchg.Count & " files. Do you want to discard these changes?", "Yes", "No") = 2 THEN RETURN
  END IF
  
  INC Application.Busy
  Status.Text = "Scanning directory "
  IF $recursive THEN  
    Status.Text &= "recursively "
  END IF
  Status.Text &= "for .mp3-files"
  WAIT 0.001
  
  Flist.Clear
  FOR x = 0 TO Flist.Columns.Count - 1
    Flist.Columns[x].Width = 50
  NEXT 
  fall = NEW Collection
  fchg = NEW Collection
  
  IF $recursive THEN 
    pass = RDir(DirView1.Current, "*.mp3")
    IF pass.Count > 250 THEN
      DEC Application.Busy
      IF Message.Warning("Do you really want to display all files in this Directory recursively? This might take quite a long time...", "Yes", "No") = 2 THEN
        ToggleButton2.Value = FALSE
        RETURN
      END IF
      INC Application.Busy
    END IF
  ELSE
    pass = Dir(DirView1.Current, "*.mp3")
  END IF
  FOR x = 0 TO pass.Max ' absolute paths to files in pass
    e = NEW CFile(DirView1.Current &/ pass[x])
    Flist.Add(e)
    'pass[x] = DirView1.Current &/ pass[x]
  NEXT
  ProgressBar1.Visible = TRUE
  ToolButton1.Enabled = TRUE
  'UpdFFlist(pass)
  
  Status.Text = "Showing ID3v" & Str($aktTag) & "-Tag of " & Str(Flist.Count) & " files"
  ProgressBar1.Visible = FALSE
  ToolButton1.Enabled = FALSE
  DEC Application.Busy
  
END


' adds all files specified in files to Flist, returns how many files are read
PUBLIC SUB UpdFFlist(files AS String[])
  
  DIM vt AS CFile
  DIM t AS String
  DIM c AS Integer = files.Count
  DIM x AS Integer
  'DIM a AS Float = Timer()
  'DIM tmp AS Integer
  
  FOR EACH t IN files
    INC x
    vt = NEW CFile(t)
    vt.tag.aktTag = $aktTag
    Flist.Add(t, File.Name(t))
    fall.Add(vt, t)
    IF (x MOD 10) = 0 THEN
      Status.Text = "Reading file-Tags (" & Str(x) & "/" & Str(c) & ")"
      ProgressBar1.Value = x / c
      WAIT 0.001
      IF halt THEN  
        halt = FALSE
        BREAK 
      END IF
    END IF
  NEXT
  
  actFlist
  'FeditEntries(files, getACFiles(files))
  
END

' ' updates all files specified if keys with either the corresponding tag in ftags
' ' or - if ftags contains only one entry - this tag (for multiple file-updates)
' ' replaced by actFlist
' PUBLIC SUB FeditEntries(keys AS String[], ftags AS Object[])
'   
'   DIM t AS String
'   DIM a AS CTag
'   DIM x AS Integer
'   
'   IF NOT (keys.Count = ftags.Count OR ftags.Count = 1) THEN STOP 
'   
'   IF ftags.Count = 1 THEN 
'     FOR x = 0 TO keys.Max
'       FeditEntry(keys[x], ftags[0])
'     NEXT 
'   ELSE 
'     FOR x = 0 TO keys.Max
'       FeditEntry(keys[x], ftags[x])
'     NEXT 
'   END IF
'   
'   Flist.Columns[0].Width = 50
'   Flist.Columns[0].AutoResize = TRUE
'   Flist.Columns[1].Width = 50
'   Flist.Columns[1].AutoResize = TRUE
'   Flist.Columns[2].Width = 50
'   Flist.Columns[2].AutoResize = TRUE
'   Flist.Columns[3].Width = 50
'   Flist.Columns[3].AutoResize = TRUE
'   Flist.Columns[4].Width = 50
'   Flist.Columns[4].AutoResize = TRUE
'   Flist.Columns[5].Width = 50
'   Flist.Columns[5].AutoResize = TRUE
'   Flist.Columns[6].Width = 50
'   Flist.Columns[6].AutoResize = TRUE
'   Flist.Columns[7].Width = 50
'   Flist.Columns[7].AutoResize = TRUE
'   
' END

' updates the Tag-Fields in Flist for file specified in t
PUBLIC SUB FeditEntry(t AS String, f AS Object)
  
  DIM ftag AS CTag
  DIM b AS NEW Picture
  DIM e AS NEW Picture
  
  b = Picture.Load("icons/16/blank.png")
  e = Picture.Load("icons/16/edited.png")
  
  IF (Object.Type(f) = "CFile") THEN
    ftag = f.tag
  ELSE IF (Object.Type(f) = "CTag") THEN
    ftag = f
  ELSE
    RETURN 
  END IF
  
  Flist[t][1] = ftag.title
  Flist[t][2] = ftag.artist
  Flist[t][3] = ftag.album
  IF ftag.year > 0 THEN Flist[t][4] = Str(ftag.year)
  Flist[t][5] = ftag.genre
  IF ftag.track > 0 THEN Flist[t][6] = Str(ftag.track)
  IF (Object.Type(f) = "CFile") THEN Flist[t][7] = If(f.header.bitrate = -1, "VBR", Str(f.header.bitrate))
  Flist[t].Picture = If(f.changed, e, b)
  
END

' MouseClick or other change of selected item in left DirView
PUBLIC SUB DirView1_Select()
  UpdFlist
END

' change from viewing the v1-Tag to v2-Tag or the other way round
PUBLIC SUB ToolButton2_Click()
  $aktTag = If($aktTag = 1, 2, 1)
  ToolButton2.Text = "Showing ID3v" & $aktTag & "-Tag"
  UpdFlist
END

' get (original, not modified) path to files of all selected entries in FList 
PUBLIC FUNCTION getSelected() AS String[]
  
  DIM result AS NEW String[]
  DIM x AS Integer
  
  IF Flist.Count = 0 THEN RETURN result
  Flist.MoveFirst
  DO
    IF Flist.Item.Selected THEN result.Add(Flist.Item.Key)
    INC x
  LOOP UNTIL Flist.MoveBelow()
  Flist.MoveBack
  RETURN result
  
END

' get all files as CFile from fall, meaning the (possibly) modified versions
PUBLIC FUNCTION getACFiles(files AS String[]) AS Object[]
  
  DIM t AS String
  DIM x AS Integer
  DIM result AS NEW Object[]
  
  FOR EACH t IN files
    result.Add(fall[t])
  NEXT 
  RETURN result
  
END

' get all Tags of version if specified (CTagv1 or CTagv2) otherwise CTag
PUBLIC FUNCTION getACTags(files AS String[], OPTIONAL version AS Integer = 0) AS Object[]
  
  DIM t AS String
  DIM x AS Integer
  DIM result AS NEW Object[]
  
  IF IsNull(files) THEN RETURN []
  
  IF version = 0 THEN 
    FOR EACH t IN files
      result.Add(fall[t].tag)
    NEXT 
  ELSE IF version = 1 THEN 
    FOR EACH t IN files
      result.Add(FList.fall[t].Tag.v1)
    NEXT 
  ELSE IF version = 2 THEN 
    FOR EACH t IN files
      result.Add(fall[t].Tag.v2)
    NEXT 
  END IF
  RETURN result
  
END

' show hidden files / directories
PUBLIC SUB ToggleButton1_Click()
  DirView1.ShowHidden = ToggleButton1.Value
  UpdFlist
END
' scan directories recursively
PUBLIC SUB ToggleButton2_Click()
  $recursive = ToggleButton2.Value
  UpdFlist
END

' Renaming in Flist
PUBLIC SUB Flist_Rename()
' 
'   DIM b AS CFile = fall[Flist.Current.Key]
'   
'   DIM a AS String = Flist.Current.Key
'   DIM n AS String = File.Dir(a) &/ Flist[a][0]
'   
  message("BLA")
'   IF a = n THEN RETURN
'   b.newpath = n
'   
'   Flist.Add(n, File.Name(n), Picture.Load("icons/16/edited.png"), NULL, a)
'   Flist[n][1] = Flist[a][1]
'   Flist[n][2] = Flist[a][2]
'   Flist[n][3] = Flist[a][3]
'   Flist[n][4] = Flist[a][4]
'   Flist[n][5] = Flist[a][5]
'   Flist[n][6] = Flist[a][6]
'   Flist.Remove(a)
' 
END

PUBLIC SUB updFFile(fkey AS String)
  
  DIM x AS Integer
  DIM a AS CFile = fall[fkey]
  DIM b AS NEW Picture
  DIM e AS NEW Picture
  
  b = Picture.Load("icons/16/blank.png")
  e = Picture.Load("icons/16/edited.png")
  
  FOR x = 0 TO cols.Max
    Flist[a.path][x] = MHelp.getDesc(cols[x], a)
    Flist[a.path].Picture = If(a.changed, e, b)
  NEXT 
  
END


PUBLIC SUB renameFFile(fkey AS String, newname AS String)
  
  DIM d AS String
  DIM b AS CFile = fall[fkey]
  DIM f AS Integer
  
  IF File.Name(b.path) = newname THEN RETURN 
  b.newpath = File.Dir(b.path) &/ newname &/ File.Ext(b.path)
  
  f = cols.Find("%f")
  updFFile(fkey)
  
END


' Edit ID3v1-Tag of selected files
PUBLIC SUB ToolButton6_Click()

  DIM sel AS String[]
  DIM edit AS Object[]
  DIM t AS String
  
  sel = getSelected()
  edit = getACTags(sel, 1)
  
  fsel = NEW CTag
  'fsel.v1 = CTagv1.mergeTags(edit)
  fsel.v1 = MHelp.merge(edit)
  IF IsNull(fsel.v1) THEN RETURN 
  IF FEditv1.Run() THEN 
    FOR EACH t IN sel
      fall[t].Tag.v1 = FEditv1.v1tag.v1
      Message(MHelp.isSame(fsel.v1, FEditv1.v1tag.v1))
      fchg.Add(fall[t], t)
      FeditEntry(t, FEditv1.v1tag)
    NEXT 
  END IF

END

PRIVATE FUNCTION changed_Read() AS Boolean

  DIM t AS CFile
  DIM result AS Boolean
  
  FOR EACH t IN fall
    result = result OR t.changed
  NEXT 
  RETURN result

END

' Quit
PUBLIC SUB Menu2_Click()
  Form_Close
END

' show file-header
PUBLIC SUB Menu4_Click()
  
  DIM t AS String
  DIM f AS CFile
  
  f = getACFiles(getSelected())[0]
  t = "Bitrate: %b" & Chr(10)
  t &= "MP3-Type: MPEG " & f.header.mpegversion & " Layer " & f.header.layer & Chr(10)
  t &= "Sample-Rate: %s" & Chr(10)
  t &= "Channels: " & Choose(f.header.channels + 1, "Stereo", "Joint-Stereo", "Dual-Mono", "Mono")
  Message(MHelp.replaceByPattern(t, f))
  
END


PUBLIC SUB Flist_Menu()
  IF getSelected().Count > 0 THEN Menu3.Popup
END

' generate torrent-description
PUBLIC SUB DirView1_Menu()

  

END

PUBLIC SUB ToolButton1_Click()
  ToolButton1.Enabled = FALSE
  halt = TRUE
END

PUBLIC SUB Menu14_Click()

  IF FConfig.Run() THEN 
   Flist.cols = Settings["cols"]
    Flist.tips = Settings["tips"]
    'actFlist
  END IF

END

PUBLIC SUB Form_Close()

  Settings["cols"] = cols.Join(",")
  Settings.Save
  ME.Delete

END
